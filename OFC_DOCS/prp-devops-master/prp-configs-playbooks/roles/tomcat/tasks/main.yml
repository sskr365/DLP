---
# tasks file for tomcat
- name: block for copying {{ configfile }} to {{ ENV }}_{{ instance }} server
  block:
  - name: backup of {{ configfile }}
    shell:
      cp -p /opt/cloudhost/liferay-tomcat/liferay_instance{{ num }}/{{ TomcatVersion }}/conf/context.xml  /opt/cloudhost/liferay-tomcat/configfiles-backup/{{ instance }}/context.xml-`date +%Y.%m.%d.%H.%M.%S`

  - name: copying {{ configfile }} file to {{ ENV }}_{{ instance }} target location
    copy:
      src: "{{ propertyfiles_src }}/{{ ENV }}/{{ app }}/{{ instance }}/context.xml"
      dest: /opt/cloudhost/liferay-tomcat/liferay_instance{{ num }}/{{ TomcatVersion }}/conf/context.xml
      remote_src: no
      owner: liferay
      group: liferaygrp
      mode: 0755
  tags: context.xml

- name: block for copying {{ configfile }} to {{ ENV }}_{{ instance }} server
  block:
  - name: backup of {{ configfile }}
    shell:
      cp -p /opt/cloudhost/liferay-tomcat/liferay_instance{{ num }}/{{ TomcatVersion }}/conf/server.xml  /opt/cloudhost/liferay-tomcat/configfiles-backup/{{ instance }}/server.xml-`date +%Y.%m.%d.%H.%M.%S`

  - name: copying server.xml file to {{ ENV }}_{{ instance }} target location
    template:
      src: "{{ propertyfiles_src }}/{{ ENV }}/{{ app }}/{{ instance }}/template/server.xml.j2"
      dest: /opt/cloudhost/liferay-tomcat/liferay_instance{{ num }}/{{ TomcatVersion }}/conf/server.xml
      remote_src: no
      owner: liferay
      group: liferaygrp
      mode: 0755
  tags: server.xml


- name: block for copying {{ configfile }} to {{ ENV }}_{{ instance }} server
  block:
  - name: backup of {{ configfile }}
    shell:
      cp -p /opt/cloudhost/liferay-tomcat/liferay_instance{{ num }}/{{ TomcatVersion }}/bin/setenv.sh /opt/cloudhost/liferay-tomcat/configfiles-backup/{{ instance }}/setenv.sh-`date +%Y.%m.%d.%H.%M.%S`

  - name: copying setenv.sh file to {{ ENV }}_{{ instance }} target location
    copy:
      src: "{{ propertyfiles_src }}/{{ ENV }}/{{ app }}/{{ instance }}/setenv.sh"
      dest: /opt/cloudhost/liferay-tomcat/liferay_instance{{ num }}/{{ TomcatVersion }}/bin/setenv.sh
      remote_src: no
      owner: liferay
      group: liferaygrp
      mode: 0755
  tags: setenv.sh

- name: block for copying {{ configfile }} to {{ ENV }}_{{ instance }} server
  block:
  - name: backup of {{ configfile }}
    shell:
      cp -p /opt/cloudhost/liferay-tomcat/liferay_instance{{ num }}/{{ TomcatVersion }}/bin/shutdown.sh /opt/cloudhost/liferay-tomcat/configfiles-backup/{{ instance }}/shutdown.sh-`date +%Y.%m.%d.%H.%M.%S`

  - name: copying shutdown.sh file to {{ ENV }}_{{ instance }} target location
    copy:
      src: "{{ propertyfiles_src }}/{{ ENV }}/{{ app }}/{{ instance }}/shutdown.sh"
      dest: /opt/cloudhost/liferay-tomcat/liferay_instance{{ num }}/{{ TomcatVersion }}/bin/shutdown.sh
      remote_src: no
      owner: liferay
      group: liferaygrp
      mode: 0755
  tags: shutdown.sh

- name: block for copying {{ configfile }} to {{ ENV }}_{{ instance }} server
  block:
  - name: backup of {{ configfile }}
    shell:
      cp -p /opt/cloudhost/liferay-tomcat/liferay_instance{{ num }}/{{ TomcatVersion }}/bin/startup.sh  /opt/cloudhost/liferay-tomcat/configfiles-backup/{{ instance }}/startup.sh-`date +%Y.%m.%d.%H.%M.%S`

  - name: copying startup.sh file to {{ ENV }}_{{ instance }} target location
    copy:
      src: "{{ propertyfiles_src }}/{{ ENV }}/{{ app }}/{{ instance }}/startup.sh"
      dest: /opt/cloudhost/liferay-tomcat/liferay_instance{{ num }}/{{ TomcatVersion }}/bin/startup.sh
      remote_src: no
      owner: liferay
      group: liferaygrp
      mode: 0755
  tags: startup.sh

  
- name: block for copying {{ configfile }} to {{ ENV }}_{{ instance }} server
  block:
  - name: backup of {{ configfile }}
    shell:
      cp -p /opt/cloudhost/liferay-tomcat/liferay_instance{{ num }}/{{ TomcatVersion }}/webapps/ROOT/WEB-INF/web.xml /opt/cloudhost/liferay-tomcat/configfiles-backup/{{ instance }}/ROOT_WEB-INF_web.xml-`date +%Y.%m.%d.%H.%M.%S`

  - name: copying web.xml file to {{ ENV }}_{{ instance }} target location
    copy:
      src: "{{ propertyfiles_src }}/{{ ENV }}/{{ app }}/{{ instance }}/ROOT_WEB-INF_web.xml"
      dest: /opt/cloudhost/liferay-tomcat/liferay_instance{{ num }}/{{ TomcatVersion }}/webapps/ROOT/WEB-INF/web.xml
      remote_src: no
      owner: liferay
      group: liferaygrp
      mode: 0755
  tags: ROOT_WEB-INF_web.xml
  
   
  
- name: block for restarting {{ instance }} services
  block:
  - name: Starting the {{ instance }} services
    command: su liferay -c  'sh /opt/cloudhost/liferay-tomcat/liferay_instance{{ num }}/{{ TomcatVersion }}/bin/startup.sh'
  tags:
    - "yes"
...
